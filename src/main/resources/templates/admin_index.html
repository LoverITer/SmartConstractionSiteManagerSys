<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>后台管理-智慧工地后台管理系统 - v1.0</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="../static/css/font.css" th:src="@{/static/css/font.css}">
    <link rel="stylesheet" href="../static/css/weadmin.css" th:src="@{/static/css/weadmin.css}">
    <script src="../static/lib/layui/layui.js" charset="utf-8" th:src="@{/static/lib/layui/layui.js}"></script>
    <script src="../static/js/common.js" th:src="@{/static/js/common.js}"></script>
</head>
<body>
<!-- 顶部开始 -->
<div class="container">
    <div class="logo">
        <a th:href="@{/admin/index(token=${token})}">智慧工地后台管理系统</a>
    </div>
    <div class="left_open">
        <!-- <i title="展开左侧栏" class="iconfont">&#xe699;</i> -->
        <i title="展开左侧栏" class="layui-icon layui-icon-shrink-right"></i>
    </div>
    <ul class="layui-nav right" lay-filter="">
        <li class="layui-nav-item">
            <a id="username" href="javascript:void(0);">Admin</a>
            <dl class="layui-nav-child">
                <!-- 二级菜单 -->
                <dd>
                    <a th:href="@{/admin/about(token=${token})}" onclick="WeAdminShow('个人信息','http://www.baidu.com')">个人信息</a>
                </dd>
                <dd>
                    <a th:href="@{/user/logout(token=${token})}" onclick="WeAdminShow('切换帐号','./login.html')">切换帐号</a>
                </dd>
                <dd>
                    <a class="loginout" th:href="@{/user/logout(token=${token})}" href="./login.html">退出</a>
                </dd>
            </dl>
        </li>
        <li class="layui-nav-item to-index">
            <a th:href="@{/admin/index(token=${token})}" target="_blank">前台首页</a>
        </li>
    </ul>
</div>
<!-- 顶部结束 -->
<!-- 中部开始 -->
<!-- 左侧菜单开始 -->
<div class="left-nav">
    <div id="side-nav">
        <ul class="nav" id="nav">
            <li id="menu1" class="open"><a _href=""><i class="layui-icon layui-icon-user"></i><cite>人员管理</cite><i
                    class="iconfont nav_right"></i></a>
                <ul class="sub-menu" style="display: block;">
                    <li id="menu1-1"><a _href="./member/list.html"><i class="iconfont"></i><cite>人员列表</cite></a>
                    </li>
                </ul>
            </li>
            <li id="menu2"><a _href=""><i class="layui-icon layui-icon-read"></i><cite>设备管理</cite><i
                    class="iconfont nav_right"></i></a>
                <ul class="sub-menu" style="">
                    <li id="menu2-1"><a _href="./device/list.html"><i class="iconfont"></i><cite>监控摄像机管理</cite></a>
                    </li>
                    <li id="menu2-2"><a _href="./device/list.html"><i class="iconfont"></i><cite>传感器管理</cite></a>
                    </li>
                </ul>
            </li>
            <li id="menu3"><a _href=""><i class="layui-icon layui-icon-util"></i><cite>管理员权限</cite><i
                    class="iconfont nav_right"></i></a>
                <ul class="sub-menu" style="">
                    <li id="menu3-1"><a _href="./administrator/list.html"><i
                            class="iconfont"></i><cite>管理员列表</cite></a>
                    </li>
                    <li id="menu3-2"><a _href="./administrator/role.html"><i class="iconfont"></i><cite>角色管理</cite></a>
                    </li>
                    <li id="menu3-3"><a _href="./administrator/rule.html"><i class="iconfont"></i><cite>权限管理</cite></a>
                    </li>
                </ul>
            </li>
            <li id="menu4"><a _href=""><i class="layui-icon layui-icon-form"></i><cite>工程进度管理</cite><i
                    class="iconfont nav_right"></i></a>
                <ul class="sub-menu" style="">
                    <li id="menu4-1"><a _href="./administrator/list.html"><i
                            class="iconfont"></i><cite>工程进度列表</cite></a>
                    </li>
                </ul>
            </li>
            <li id="menu5"><a _href=""><i class="layui-icon layui-icon-chart"></i><cite>工程预算管理</cite><i
                    class="iconfont nav_right"></i></a>
                <ul class="sub-menu" style="">
                    <li id="menu5-1"><a _href="./administrator/list.html"><i
                            class="iconfont"></i><cite>工程预算列表</cite></a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!-- <div class="x-slide_left"></div> -->
<!-- 左侧菜单结束 -->
<!-- 右侧主体开始 -->
<div class="page-content">
    <div class="layui-tab tab" lay-filter="wenav_tab" id="WeTabTip" lay-allowclose="true">
        <ul class="layui-tab-title" id="tabName">
            <li>我的桌面</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <iframe th:src='@{/welcome.html}' frameborder="0" scrolling="yes" class="weIframe"></iframe>
            </div>
        </div>
    </div>
</div>
<div class="page-content-bg"></div>
<!-- 右侧主体结束 -->
<!-- 中部结束 -->
<!-- 底部开始 -->
<div class="footer">
    <div class="copyright">Copyright ©2021 智慧工地后台管理系统 v1.0 All Rights Reserved</div>
</div>
<!-- 底部结束 -->
<script type="text/javascript">

    var TOKEN = localStorage.getItem(USER_LOGIN_TOKEN);

    layui.config({
        base: '../static/js/'
        , version: '101100'
    }).extend({ //设定模块别名
        admin: 'admin'
        , menu: 'menu'
    });
    layui.use(['jquery', 'admin', 'menu',"layer"], function () {
        var $ = layui.jquery,
            admin = layui.admin,
            menu = layui.menu,
            layer=layui.layer;

        /**
         * 判断用户会话是否过期
         */
        function isUserSessionExpire() {
            $.ajax({
                url: "/user/session_status",
                method: "get",
                contentType: "application/json",
                sync: false,
                data: {"token": TOKEN},
                success: function (response) {
                    if (response.code === 200) {
                        if(!response.data){
                            layer.confirm('会话过期?', {icon: 3, title:'系统提示'}, function(index){
                                //do something

                                layer.close(index);
                            });
                        }
                    } else {
                        layer.msg(response.msg);
                    }
                },
                error: function (response) {
                    layer.open({
                        type: 1,
                        title: '出错啦！',
                        content: response.msg,
                    });
                }
            });
        }

        function powerCtrl(role_id) {
            if (undefined === role_id || role_id === "") {
                layer.msg("用户权限参数有误，权限功能将异常", {icon: 2});
            }
            if (1 === role_id || 2 === role_id) {
                //系统管理员 或者是 项目经理登陆之后具有全部的权限，这里直接返回即可
                //do nothing
            } else if (3 === role_id) {
                //总工程师 没有管理员管理权限
                $('#menu3').remove();
            } else if (4 === role_id) {
                //安全员只对安全管理以及安全设备管理有权限
                $('#menu1').remove();
                $('#menu3').remove();
                $('#menu4').remove();
                $('#menu5').remove();
            } else if (5 === role_id) {
                //施工员只对工程进度管理有权限
                $('#menu1').remove();
                $('#menu2').remove();
                $('#menu3').remove();
                $('#menu5').remove();
            } else if (6 === role_id) {
                //造价员只对工程预算管理有权限
                $('#menu1').remove();
                $('#menu2').remove();
                $('#menu3').remove();
                $('#menu4').remove();
            }else{
                $('#nav').remove();
            }
        }

        function getUserInfo(){
            $.ajax({
                url: "/user/info",
                method: "get",
                contentType: "application/json",
                sync: false,
                data: {"token": TOKEN},
                success: function (response) {
                    if (response.code === 200) {
                        //console.log(response.data);
                        powerCtrl(response.data.roleId);
                        $('#username').html(response.data.username + "<span class=\"layui-nav-more\"></span>");
                    } else {
                        layer.msg(response.msg);
                    }
                },
                error: function (response) {
                    layer.open({
                        type: 1,
                        title: '出错啦！',
                        content: response.msg,
                    });
                }
            });
        }

        //页面加载之后需要干的事情
        $(function () {
           getUserInfo();
           setInterval(function () {
               $.ajax({
                   url: "/user/session_status",
                   method: "get",
                   contentType: "application/json",
                   sync: false,
                   data: {"token": TOKEN},
                   success: function (response) {
                       if (response.code === 200) {
                           if(!response.data){
                               layer.confirm('您已经登陆超时，需要重新登陆。', {
                                   btn: ['确定'],icon: 3, title:'会话超时'
                               }, function(index){
                                   window.location.href = '/login.html';
                                   layer.close(index);
                               });
                           }
                       }
                   }
               });
           },60*1000);
        });

    });

</script>
</body>
<!--Tab菜单右键弹出菜单-->
<ul class="rightMenu" id="rightMenu">
    <li data-type="fresh">刷新</li>
    <li data-type="current">关闭当前</li>
    <li data-type="other">关闭其它</li>
    <li data-type="all">关闭所有</li>
</ul>

</html>